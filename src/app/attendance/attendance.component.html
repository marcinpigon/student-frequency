<div class="attendance-container">
  <mat-card class="header-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>assessment</mat-icon>
        Wprowadzanie Frekwencji Semestralnej/Rocznej
      </mat-card-title>
      <mat-card-subtitle>
        Wprowadź całkowitą liczbę godzin frekwencji dla semestru lub całego roku
        akademickiego
      </mat-card-subtitle>
    </mat-card-header>
  </mat-card>

  <mat-card class="form-card">
    <mat-card-content>
      @if (attendanceForm) {
      <form [formGroup]="attendanceForm" class="attendance-form">
        <!-- Class Selection and Date -->
        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Wybierz Klasę</mat-label>
            <mat-select
              formControlName="classId"
              (selectionChange)="onClassChange($event.value)"
            >
              @for (class of classes; track class) {
              <mat-option [value]="class.id">
                {{ class.name }} - {{ class.academicYear }} ({{
                  class.semester === "Winter"
                    ? "Zimowy"
                    : class.semester === "Summer"
                    ? "Letni"
                    : class.semester
                }})
              </mat-option>
              }
            </mat-select>
            <mat-hint>Wybierz klasę do wprowadzenia frekwencji</mat-hint>
          </mat-form-field>
        </div>

        @if (selectedClass) {
        <div class="form-row">
          <mat-form-field appearance="outline" class="third-width">
            <mat-label>Typ Okresu</mat-label>
            <mat-select formControlName="period">
              <mat-option value="semester">Semestr</mat-option>
              <mat-option value="year">Cały Rok</mat-option>
            </mat-select>
            <mat-hint>Wybierz okres raportowania</mat-hint>
          </mat-form-field>

          @if (attendanceForm.get('period')?.value === 'semester') {
          <mat-form-field appearance="outline" class="third-width">
            <mat-label>Semestr</mat-label>
            <mat-select formControlName="semester">
              <mat-option value="Winter">Zimowy</mat-option>
              <mat-option value="Summer">Letni</mat-option>
            </mat-select>
            <mat-hint>Wybierz semestr</mat-hint>
          </mat-form-field>
          }

          <mat-form-field appearance="outline" class="third-width">
            <mat-label>Rok Akademicki</mat-label>
            <input matInput formControlName="academicYear" />
            <mat-hint>np. 2024-2025</mat-hint>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="half-width">
            <mat-label>Całkowita Liczba Godzin w Okresie</mat-label>
            <input
              matInput
              type="number"
              formControlName="totalClassHours"
              min="1"
              (input)="onTotalClassHoursChange($any($event.target).value)"
            />
            <mat-hint
              >Całkowita liczba zaplanowanych godzin w całym okresie</mat-hint
            >
          </mat-form-field>
        </div>
        }

        <!-- Student Attendance Table -->
        @if (students.length > 0) {
        <div class="students-section" formArrayName="students">
          <h3>Frekwencja Uczniów ({{ students.length }} uczniów)</h3>
          <div class="table-container">
            <table
              mat-table
              [dataSource]="studentsArray.controls"
              class="attendance-table"
            >
              <!-- Student Name Column -->
              <ng-container matColumnDef="studentName">
                <th mat-header-cell *matHeaderCellDef>Imię i Nazwisko</th>
                <td
                  mat-cell
                  *matCellDef="let studentForm; let i = index"
                  [formGroupName]="i"
                >
                  <strong>{{ studentForm.get("studentName")?.value }}</strong>
                </td>
              </ng-container>
              <!-- Hours Present Column -->
              <ng-container matColumnDef="hoursPresent">
                <th mat-header-cell *matHeaderCellDef>Suma Godzin Obecności</th>
                <td
                  mat-cell
                  *matCellDef="let studentForm; let i = index"
                  [formGroupName]="i"
                >
                  <mat-form-field appearance="outline" class="table-field">
                    <input
                      matInput
                      type="number"
                      formControlName="totalHoursPresent"
                      min="0"
                      [max]="attendanceForm.get('totalClassHours')?.value"
                      step="1"
                    />
                  </mat-form-field>
                  <div
                    class="percentage-indicator"
                    [class.good]="
                      getStudentPresencePercentage(
                        studentForm.get('totalHoursPresent')?.value
                      ) >= 75
                    "
                    [class.warning]="
                      getStudentPresencePercentage(
                        studentForm.get('totalHoursPresent')?.value
                      ) < 75
                    "
                  >
                    {{
                      getStudentPresencePercentage(
                        studentForm.get("totalHoursPresent")?.value
                      ).toFixed(0)
                    }}%
                  </div>
                </td>
              </ng-container>
              <!-- Hours Absent Column -->
              <ng-container matColumnDef="hoursAbsent">
                <th mat-header-cell *matHeaderCellDef>
                  Suma Godzin Nieobecności
                </th>
                <td
                  mat-cell
                  *matCellDef="let studentForm; let i = index"
                  [formGroupName]="i"
                >
                  <mat-form-field appearance="outline" class="table-field">
                    <input
                      matInput
                      type="number"
                      formControlName="totalHoursAbsent"
                      min="0"
                      [max]="attendanceForm.get('totalClassHours')?.value"
                      step="1"
                      readonly
                    />
                  </mat-form-field>
                </td>
              </ng-container>
              <!-- Notes Column -->
              <ng-container matColumnDef="notes">
                <th mat-header-cell *matHeaderCellDef>Uwagi</th>
                <td
                  mat-cell
                  *matCellDef="let studentForm; let i = index"
                  [formGroupName]="i"
                >
                  <mat-form-field
                    appearance="outline"
                    class="table-field notes-field"
                  >
                    <input
                      matInput
                      formControlName="notes"
                      placeholder="Opcjonalne uwagi (np. choroba, usprawiedliwiona)"
                    />
                  </mat-form-field>
                </td>
              </ng-container>
              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
            </table>
          </div>
          <!-- Save Actions -->
          <div class="save-actions">
            <button
              mat-raised-button
              color="primary"
              type="button"
              (click)="saveAttendance()"
              [disabled]="attendanceForm.invalid"
            >
              <mat-icon>save</mat-icon>
              Zapisz Frekwencję
            </button>
            <button mat-raised-button type="button" (click)="resetForm()">
              <mat-icon>clear</mat-icon>
              Wyczyść Formularz
            </button>
          </div>
        </div>
        }

        <!-- Empty State -->
        @if (students.length === 0 && selectedClass) {
        <div class="empty-state">
          <mat-icon>info</mat-icon>
          <p>Brak uczniów w tej klasie. Proszę najpierw dodać uczniów.</p>
        </div>
        } @if (!selectedClass) {
        <div class="empty-state">
          <mat-icon>school</mat-icon>
          <p>Wybierz klasę aby rozpocząć rejestrowanie frekwencji</p>
        </div>
        }
      </form>
      }
    </mat-card-content>
  </mat-card>

  <!-- Info Card -->
  <mat-card class="info-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>info</mat-icon>
        How to Use
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <ol>
        <li><strong>Select a class</strong> from the dropdown menu</li>
        <li><strong>Choose period type</strong> (Semester or Full Year)</li>
        <li>
          <strong>Select semester</strong> if choosing semester mode (Winter or
          Summer)
        </li>
        <li>
          <strong>Set total class hours</strong> for the entire period (e.g.,
          180 hours for a semester)
        </li>
        <li>
          <strong>Enter total hours present</strong> for each student (hours
          absent will auto-calculate)
        </li>
        <li><strong>Add optional notes</strong> for special circumstances</li>
        <li><strong>Click Save</strong> to record the attendance</li>
      </ol>
      <p class="tip">
        <mat-icon>lightbulb</mat-icon>
        <strong>Tip:</strong> This is for entering totals at the end of a
        semester or year, not daily attendance. Enter the cumulative hours for
        the entire period.
      </p>
    </mat-card-content>
  </mat-card>
</div>
