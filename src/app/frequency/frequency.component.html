<div class="frequency-container">
  <mat-card class="header-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>assessment</mat-icon>
        Raport Frekwencji
      </mat-card-title>
      <mat-card-subtitle>
        Generuj raporty frekwencji dla semestru lub roku
      </mat-card-subtitle>
    </mat-card-header>
  </mat-card>

  <mat-card class="form-card">
    <mat-card-content>
      @if (reportForm) {
      <form [formGroup]="reportForm" class="report-form">
        <mat-form-field appearance="outline">
          <mat-label>Wybierz Klasę</mat-label>
          <mat-select
            formControlName="classId"
            (selectionChange)="onClassChange($event.value)"
          >
            @for (class of classes; track class.id) {
            <mat-option [value]="class.id">
              {{ class.name }} - {{ class.academicYear }}
            </mat-option>
            }
          </mat-select>
        </mat-form-field>

        <div class="period-selector">
          <label class="period-label">Okres Raportu:</label>
          <mat-radio-group formControlName="period" class="period-radio">
            <mat-radio-button value="semester">Semestr</mat-radio-button>
            <mat-radio-button value="year">Rok</mat-radio-button>
          </mat-radio-group>
        </div>

        @if (reportForm.get('period')?.value === 'semester') {
        <mat-form-field appearance="outline">
          <mat-label>Semestr</mat-label>
          <mat-select formControlName="semester">
            <mat-option value="Winter">Zimowy</mat-option>
            <mat-option value="Summer">Letni</mat-option>
          </mat-select>
        </mat-form-field>
        }

        <div class="button-group">
          <button
            mat-raised-button
            color="primary"
            (click)="generateReport()"
            [disabled]="reportForm.invalid"
          >
            <mat-icon>bar_chart</mat-icon>
            Generuj Raport
          </button>

          <button
            mat-raised-button
            color="accent"
            (click)="addSampleAttendance()"
            [disabled]="!selectedClass"
          >
            <mat-icon>add_circle</mat-icon>
            Dodaj Przykładowe Dane
          </button>

          <button mat-raised-button (click)="clearReport()">
            <mat-icon>clear</mat-icon>
            Wyczyść
          </button>
        </div>
      </form>
      }
    </mat-card-content>
  </mat-card>

  @if (frequencyReport) {
  <mat-card class="report-card">
    <mat-card-header>
      <mat-card-title>
        Raport dla {{ frequencyReport.className }}
      </mat-card-title>
      <mat-card-subtitle>
        {{
          frequencyReport.period === "semester"
            ? "Semestr: " + (frequencyReport.semester === "Winter" ? "Zimowy" : "Letni")
            : "Cały Rok"
        }}
        - Rok Akademicki:
        {{ frequencyReport.academicYear }}
      </mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div class="summary-info">
        <div class="summary-item">
          <strong>Całkowita Liczba Godzin:</strong>
          {{ frequencyReport.totalClassHours.toFixed(2) }}
        </div>
        <div class="summary-item">
          <strong>Średnia Obecność Klasy:</strong>
          {{ frequencyReport.classAveragePresence.toFixed(2) }}%
        </div>
        <div class="summary-item">
          <strong>Średnia Nieobecność Klasy:</strong>
          {{ frequencyReport.classAverageAbsence.toFixed(2) }}%
        </div>
        <div class="summary-item">
          <strong>Liczba Uczniów:</strong>
          {{ frequencyReport.studentReports.length }}
        </div>
      </div>
      <div class="table-container">
        <table
          mat-table
          [dataSource]="frequencyReport.studentReports"
          class="report-table"
        >
          <!-- Student Name Column -->
          <ng-container matColumnDef="studentName">
            <th mat-header-cell *matHeaderCellDef>Imię i Nazwisko</th>
            <td mat-cell *matCellDef="let report">{{ report.studentName }}</td>
          </ng-container>
          <!-- Total Hours Present Column -->
          <ng-container matColumnDef="totalHoursPresent">
            <th mat-header-cell *matHeaderCellDef>Godziny Obecności</th>
            <td mat-cell *matCellDef="let report">
              {{ report.totalHoursPresent.toFixed(2) }}
            </td>
          </ng-container>
          <!-- Total Hours Absent Column -->
          <ng-container matColumnDef="totalHoursAbsent">
            <th mat-header-cell *matHeaderCellDef>Godziny Nieobecności</th>
            <td mat-cell *matCellDef="let report">
              {{ report.totalHoursAbsent.toFixed(2) }}
            </td>
          </ng-container>
          <!-- Total Hours Column -->
          <ng-container matColumnDef="totalHours">
            <th mat-header-cell *matHeaderCellDef>Suma Godzin</th>
            <td mat-cell *matCellDef="let report">
              {{ report.totalHours.toFixed(2) }}
            </td>
          </ng-container>
          <!-- Presence Percentage Column -->
          <ng-container matColumnDef="presencePercentage">
            <th mat-header-cell *matHeaderCellDef>Obecność %</th>
            <td
              mat-cell
              *matCellDef="let report"
              [class.high-presence]="report.presencePercentage >= 75"
              [class.low-presence]="report.presencePercentage < 75"
            >
              {{ report.presencePercentage.toFixed(2) }}%
            </td>
          </ng-container>
          <!-- Absence Percentage Column -->
          <ng-container matColumnDef="absencePercentage">
            <th mat-header-cell *matHeaderCellDef>Nieobecność %</th>
            <td
              mat-cell
              *matCellDef="let report"
              [class.high-absence]="report.absencePercentage > 25"
            >
              {{ report.absencePercentage.toFixed(2) }}%
            </td>
          </ng-container>
          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
        </table>
      </div>
      <div class="export-actions">
        <button mat-raised-button color="primary" (click)="exportReport()">
          <mat-icon>download</mat-icon>
          Eksportuj jako CSV
        </button>
      </div>
    </mat-card-content>
  </mat-card>
  } @if (!frequencyReport && reportForm.valid) {
  <mat-card class="empty-state">
    <mat-card-content>
      <mat-icon>insert_chart</mat-icon>
      <p>Kliknij "Generuj Raport" aby zobaczyć dane frekwencji</p>
    </mat-card-content>
  </mat-card>
  }
</div>
