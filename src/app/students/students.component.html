<div class="students-container">
  <mat-tab-group #tabGroup>
    <!-- Students Tab -->
    <mat-tab label="Uczniowie">
      <div class="tab-content">
        <!-- Add/Edit Student Form -->
        <mat-card class="form-card" #studentFormCard>
          <mat-card-header>
            <mat-card-title>{{
              editingStudent ? "Edytuj ucznia" : "Dodaj nowego ucznia"
            }}</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <form [formGroup]="studentForm" (ngSubmit)="onSubmitStudent()">
              <div class="form-row">
                <mat-form-field appearance="outline" class="form-field">
                  <mat-label>Imię</mat-label>
                  <input matInput formControlName="firstName" required />
                  <mat-error
                    *ngIf="studentForm.get('firstName')?.hasError('required')"
                  >
                    Imię jest wymagane
                  </mat-error>
                  <mat-error
                    *ngIf="studentForm.get('firstName')?.hasError('minlength')"
                  >
                    Imię musi mieć co najmniej 2 znaki
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="form-field">
                  <mat-label>Nazwisko</mat-label>
                  <input matInput formControlName="lastName" required />
                  <mat-error
                    *ngIf="studentForm.get('lastName')?.hasError('required')"
                  >
                    Nazwisko jest wymagane
                  </mat-error>
                  <mat-error
                    *ngIf="studentForm.get('lastName')?.hasError('minlength')"
                  >
                    Nazwisko musi mieć co najmniej 2 znaki
                  </mat-error>
                </mat-form-field>
              </div>

              <div class="form-row">
                <mat-form-field appearance="outline" class="form-field">
                  <mat-label>Email</mat-label>
                  <input matInput type="email" formControlName="email" />
                  <mat-error
                    *ngIf="studentForm.get('email')?.hasError('email')"
                  >
                    Proszę podać prawidłowy email
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="form-field">
                  <mat-label>Numer ucznia</mat-label>
                  <input matInput formControlName="studentNumber" />
                </mat-form-field>
              </div>

              <div class="form-row">
                <mat-form-field appearance="outline" class="form-field-full">
                  <mat-label>Klasa</mat-label>
                  <mat-select formControlName="classId" required>
                    <mat-option
                      *ngFor="let class of classes"
                      [value]="class.id"
                    >
                      {{ class.name }} ({{ class.academicYear }} -
                      {{ class.semester }})
                    </mat-option>
                  </mat-select>
                  <mat-error
                    *ngIf="studentForm.get('classId')?.hasError('required')"
                  >
                    Klasa jest wymagana
                  </mat-error>
                </mat-form-field>
              </div>

              <div class="form-actions">
                <button
                  mat-raised-button
                  color="primary"
                  type="submit"
                  [disabled]="!studentForm.valid"
                >
                  <mat-icon>{{
                    editingStudent ? "save" : "person_add"
                  }}</mat-icon>
                  {{ editingStudent ? "Aktualizuj ucznia" : "Dodaj ucznia" }}
                </button>
                <button
                  mat-button
                  type="button"
                  (click)="resetStudentForm()"
                  *ngIf="editingStudent"
                >
                  Anuluj
                </button>
              </div>
            </form>
          </mat-card-content>
        </mat-card>

        <!-- Students List -->
        <mat-card class="list-card">
          <mat-card-header>
            <mat-card-title
              >Lista uczniów ({{ students.length }})</mat-card-title
            >
          </mat-card-header>
          <mat-card-content>
            <div class="table-container">
              <table mat-table [dataSource]="students" class="students-table">
                <!-- Student Number Column -->
                <ng-container matColumnDef="studentNumber">
                  <th mat-header-cell *matHeaderCellDef>Nr ucznia</th>
                  <td mat-cell *matCellDef="let student">
                    {{ student.studentNumber || "-" }}
                  </td>
                </ng-container>

                <!-- First Name Column -->
                <ng-container matColumnDef="firstName">
                  <th mat-header-cell *matHeaderCellDef>Imię</th>
                  <td mat-cell *matCellDef="let student">
                    {{ student.firstName }}
                  </td>
                </ng-container>

                <!-- Last Name Column -->
                <ng-container matColumnDef="lastName">
                  <th mat-header-cell *matHeaderCellDef>Nazwisko</th>
                  <td mat-cell *matCellDef="let student">
                    {{ student.lastName }}
                  </td>
                </ng-container>

                <!-- Email Column -->
                <ng-container matColumnDef="email">
                  <th mat-header-cell *matHeaderCellDef>Email</th>
                  <td mat-cell *matCellDef="let student">
                    {{ student.email || "-" }}
                  </td>
                </ng-container>

                <!-- Class Column -->
                <ng-container matColumnDef="class">
                  <th mat-header-cell *matHeaderCellDef>Klasa</th>
                  <td mat-cell *matCellDef="let student">
                    <mat-chip>{{ getClassName(student.classId) }}</mat-chip>
                  </td>
                </ng-container>

                <!-- Enrollment Date Column -->
                <ng-container matColumnDef="enrollmentDate">
                  <th mat-header-cell *matHeaderCellDef>Data zapisania</th>
                  <td mat-cell *matCellDef="let student">
                    {{ student.enrollmentDate | date : "shortDate" }}
                  </td>
                </ng-container>

                <!-- Actions Column -->
                <ng-container matColumnDef="actions">
                  <th mat-header-cell *matHeaderCellDef>Akcje</th>
                  <td mat-cell *matCellDef="let student">
                    <button
                      mat-icon-button
                      color="primary"
                      (click)="editStudent(student)"
                      matTooltip="Edytuj"
                    >
                      <mat-icon>edit</mat-icon>
                    </button>
                    <button
                      mat-icon-button
                      color="warn"
                      (click)="deleteStudent(student)"
                      matTooltip="Usuń"
                    >
                      <mat-icon>delete</mat-icon>
                    </button>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr
                  mat-row
                  *matRowDef="let row; columns: displayedColumns"
                ></tr>

                <!-- No Data Row -->
                <tr class="mat-row" *matNoDataRow>
                  <td
                    class="mat-cell no-data"
                    [attr.colspan]="displayedColumns.length"
                  >
                    Nie znaleziono uczniów. Dodaj swojego pierwszego ucznia
                    powyżej!
                  </td>
                </tr>
              </table>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </mat-tab>

    <!-- Classes Tab -->
    <mat-tab label="Klasy">
      <div class="tab-content">
        <!-- Add/Edit Class Form -->
        <mat-card class="form-card" #classFormCard>
          <mat-card-header>
            <mat-card-title>{{
              editingClass ? "Edytuj klasę" : "Utwórz nową klasę"
            }}</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <form [formGroup]="classForm" (ngSubmit)="onSubmitClass()">
              <div class="form-row">
                <mat-form-field appearance="outline" class="form-field-full">
                  <mat-label>Nazwa klasy</mat-label>
                  <input matInput formControlName="name" required />
                  <mat-error
                    *ngIf="classForm.get('name')?.hasError('required')"
                  >
                    Nazwa klasy jest wymagana
                  </mat-error>
                  <mat-error
                    *ngIf="classForm.get('name')?.hasError('minlength')"
                  >
                    Nazwa klasy musi mieć co najmniej 3 znaki
                  </mat-error>
                </mat-form-field>
              </div>

              <div class="form-row">
                <mat-form-field appearance="outline" class="form-field-full">
                  <mat-label>Opis</mat-label>
                  <textarea
                    matInput
                    formControlName="description"
                    rows="3"
                  ></textarea>
                </mat-form-field>
              </div>

              <div class="form-row">
                <mat-form-field appearance="outline" class="form-field">
                  <mat-label>Rok akademicki</mat-label>
                  <input
                    matInput
                    formControlName="academicYear"
                    placeholder="np. 2024-2025"
                    required
                  />
                  <mat-error
                    *ngIf="classForm.get('academicYear')?.hasError('required')"
                  >
                    Rok akademicki jest wymagany
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="form-field">
                  <mat-label>Semestr</mat-label>
                  <mat-select formControlName="semester" required>
                    <mat-option value="Jesienny">Jesienny</mat-option>
                    <mat-option value="Wiosenny">Wiosenny</mat-option>
                    <mat-option value="Letni">Letni</mat-option>
                    <mat-option value="Zimowy">Zimowy</mat-option>
                  </mat-select>
                  <mat-error
                    *ngIf="classForm.get('semester')?.hasError('required')"
                  >
                    Semestr jest wymagany
                  </mat-error>
                </mat-form-field>
              </div>

              <div class="form-actions">
                <button
                  mat-raised-button
                  color="primary"
                  type="submit"
                  [disabled]="!classForm.valid"
                >
                  <mat-icon>{{ editingClass ? "save" : "add" }}</mat-icon>
                  {{ editingClass ? "Aktualizuj klasę" : "Utwórz klasę" }}
                </button>
                <button
                  mat-button
                  type="button"
                  (click)="resetClassForm()"
                  *ngIf="editingClass"
                >
                  Anuluj
                </button>
              </div>
            </form>
          </mat-card-content>
        </mat-card>

        <!-- Classes List -->
        <mat-card class="list-card">
          <mat-card-header>
            <mat-card-title>Lista klas ({{ classes.length }})</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="table-container">
              <table mat-table [dataSource]="classes" class="classes-table">
                <!-- Name Column -->
                <ng-container matColumnDef="name">
                  <th mat-header-cell *matHeaderCellDef>Nazwa klasy</th>
                  <td mat-cell *matCellDef="let class">
                    <strong>{{ class.name }}</strong>
                    <div class="class-description" *ngIf="class.description">
                      {{ class.description }}
                    </div>
                  </td>
                </ng-container>

                <!-- Academic Year Column -->
                <ng-container matColumnDef="academicYear">
                  <th mat-header-cell *matHeaderCellDef>Rok akademicki</th>
                  <td mat-cell *matCellDef="let class">
                    {{ class.academicYear }}
                  </td>
                </ng-container>

                <!-- Semester Column -->
                <ng-container matColumnDef="semester">
                  <th mat-header-cell *matHeaderCellDef>Semestr</th>
                  <td mat-cell *matCellDef="let class">
                    {{ class.semester }}
                  </td>
                </ng-container>

                <!-- Student Count Column -->
                <ng-container matColumnDef="studentCount">
                  <th mat-header-cell *matHeaderCellDef>Uczniowie</th>
                  <td mat-cell *matCellDef="let class">
                    <mat-chip color="primary">{{
                      getStudentCountForClass(class.id)
                    }}</mat-chip>
                  </td>
                </ng-container>

                <!-- Actions Column -->
                <ng-container matColumnDef="actions">
                  <th mat-header-cell *matHeaderCellDef>Akcje</th>
                  <td mat-cell *matCellDef="let class">
                    <button
                      mat-icon-button
                      color="primary"
                      (click)="editClass(class)"
                      matTooltip="Edytuj"
                    >
                      <mat-icon>edit</mat-icon>
                    </button>
                    <button
                      mat-icon-button
                      color="warn"
                      (click)="deleteClass(class)"
                      matTooltip="Usuń"
                    >
                      <mat-icon>delete</mat-icon>
                    </button>
                  </td>
                </ng-container>

                <tr
                  mat-header-row
                  *matHeaderRowDef="classDisplayedColumns"
                ></tr>
                <tr
                  mat-row
                  *matRowDef="let row; columns: classDisplayedColumns"
                ></tr>

                <!-- No Data Row -->
                <tr class="mat-row" *matNoDataRow>
                  <td
                    class="mat-cell no-data"
                    [attr.colspan]="classDisplayedColumns.length"
                  >
                    Nie znaleziono klas. Utwórz swoją pierwszą klasę powyżej!
                  </td>
                </tr>
              </table>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </mat-tab>
  </mat-tab-group>
</div>
